files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_migrate_collectstatic.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -e
      LOGFILE="/var/log/eb-django-migrations.log"
      exec > >(tee -a $LOGFILE) 2>&1
      echo "Running Django migrations and collectstatic"
      cd /var/app/current
      # Activate EB virtualenv
      source /var/app/venv/*/bin/activate || true

      # Run migrations only on leader instance
      if [[ -f /var/elasticbeanstalk/leader ]]; then
        python manage.py migrate --noinput
      fi

      # Run collectstatic on all instances
      python manage.py collectstatic --noinput
